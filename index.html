<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Cash Outs</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistema de Registro de Cash Outs</h1>
            <p>Registro y verificaci√≥n de cash outs para m√∫ltiples compa√±√≠as</p>
        </header>

        <div class="role-selector">
            <button class="role-btn operator active" id="operatorBtn">Modo Operador</button>
            <button class="role-btn supervisor" id="supervisorBtn">üîí Modo Supervisor</button>
            <button class="role-btn logout" id="logoutBtn" style="display: none;">Cerrar Sesi√≥n</button>
        </div>

        <!-- Secci√≥n operador -->
        <div id="operatorSection" class="form-section">
            <h2>Registrar nuevo cash out</h2>
            <form id="cashoutForm">
                <div class="form-group">
                    <label for="operationCode">C√≥digo de Operaci√≥n *</label>
                    <input type="text" id="operationCode" name="operationCode" required>
                </div>
                <div class="form-group">
                    <label for="operatorName">Nombre del Operador *</label>
                    <input type="text" id="operatorName" name="operatorName" required>
                </div>
                <div class="form-group">
                    <label for="company">Compa√±√≠a *</label>
                    <select id="company" name="company" required>
                        <option value="">Seleccione una compa√±√≠a</option>
                        <option value="Play Play Play">Play Play Play</option>
                        <option value="Lucky Lady">Lucky Lady</option>
                        <option value="Wise Gang">Wise Gang</option>
                        <option value="Ballerz World">Ballerz World</option>
                        <option value="Ocean Sluggerz">Ocean Sluggerz</option>
                        <option value="Elite">Elite</option>
                    </select>
                </div>
                <button type="submit">Enviar para verificaci√≥n</button>
            </form>
            <div id="operatorSuccess" class="success-message">¬°Cash out registrado correctamente! Esperando verificaci√≥n del supervisor.</div>
            <div id="operatorError" class="error-message">Ha ocurrido un error al registrar el cash out. Por favor, int√©ntalo de nuevo.</div>
        </div>

        <!-- Secci√≥n supervisor -->
        <div id="supervisorSection" class="form-section" style="display: none;">
            <h2>Cola de Verificaci√≥n</h2>
            <p>Cash outs pendientes de segunda verificaci√≥n:</p>
            <div id="verificationQueue" class="queue"><p>Cargando cash outs pendientes...</p></div>
            <div id="supervisorSuccess" class="success-message">¬°Cash out verificado!</div>
            <div id="supervisorError" class="error-message">Error al procesar el cash out.</div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="forceRefresh" style="width: auto; display: inline-block; padding: 10px 22px;">üîÑ Actualizar Cola</button>
            </div>
        </div>
    </div>
    <div id="notification" class="notification"></div>

    <script>
// URL central del Apps Script
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6DvlvBoLjGyw5kOma16aWA4F3rfepSS7vcIfL9JNjBPUL5qloWhw8fW28mug1npZt/exec";
const operatorBtn = document.getElementById('operatorBtn');
const supervisorBtn = document.getElementById('supervisorBtn');
const logoutBtn = document.getElementById('logoutBtn');
const operatorSection = document.getElementById('operatorSection');
const supervisorSection = document.getElementById('supervisorSection');
const cashoutForm = document.getElementById('cashoutForm');
const verificationQueue = document.getElementById('verificationQueue');
const notification = document.getElementById('notification');

// Permiso y push notificaci√≥n supervisor
function solicitarPermisoNotificacion() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
}
function mostrarNotificacionSupervisor(data) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Nuevo Cash Out registrado', {
            body: `Operador: ${data.operatorName}\nC√≥digo: ${data.operationCode}\nCompa√±√≠a: ${data.company}`,
            icon: 'https://cdn-icons-png.flaticon.com/512/4315/4315445.png'
        });
    }
}

// Polling notificaciones supervisor entre PCs
let lastCashoutCount = null;
async function pollingSupervisor() {
    if (sessionStorage.getItem('supervisorAuth') !== 'true') return;
    try {
        const resp = await fetch(SCRIPT_URL);
        const items = await resp.json();
        if (lastCashoutCount !== null && items.length > lastCashoutCount) {
            mostrarNotificacionSupervisor({
                operationCode: items[0].operationCode,
                operatorName: items[0].operatorName,
                company: items[0].company
            });
        }
        lastCashoutCount = items.length;
    } catch (e) {}
    setTimeout(pollingSupervisor, 8000); // revisa cada 8 segundos
}

// Auto-refresh de cola en modo supervisor
let colaAutoRefresh = null;
function iniciarAutoRefreshCola() {
    if (colaAutoRefresh) return;
    colaAutoRefresh = setInterval(() => {
        if (supervisorSection.style.display === 'block') {
            cargarCola();
        }
    }, 20000); // cada 20 segundos
}
function detenerAutoRefreshCola() {
    if (colaAutoRefresh) {
        clearInterval(colaAutoRefresh);
        colaAutoRefresh = null;
    }
}

// Centrado y cambio de modo
operatorBtn.addEventListener('click', () => {
    operatorBtn.classList.add('active');
    supervisorBtn.classList.remove('active');
    operatorSection.style.display = 'block';
    supervisorSection.style.display = 'none';
    logoutBtn.style.display = 'none';
    detenerAutoRefreshCola();
});
supervisorBtn.addEventListener('click', () => {
    const isAuthenticated = sessionStorage.getItem('supervisorAuth') === 'true';
    if (!isAuthenticated) {
        const password = prompt('Ingrese la contrase√±a de supervisor:');
        if (password === 'superctrl2023') {
            sessionStorage.setItem('supervisorAuth', 'true');
            showNotification('‚úÖ Acceso autorizado a modo supervisor', 'success');
            solicitarPermisoNotificacion();
        } else {
            showNotification('‚ùå Contrase√±a incorrecta', 'error');
            return;
        }
    } else {
        solicitarPermisoNotificacion();
    }
    supervisorBtn.classList.add('active');
    operatorBtn.classList.remove('active');
    supervisorSection.style.display = 'block';
    operatorSection.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    cargarCola();
    iniciarAutoRefreshCola();
    pollingSupervisor();
});
logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem('supervisorAuth');
    operatorBtn.click();
    showNotification('Sesi√≥n supervisor cerrada', 'success');
    detenerAutoRefreshCola();
});

// Formato Per√∫ para fechas
function formatoPeru(fechaIso) {
    const fecha = new Date(fechaIso);
    const opciones = {
        timeZone: 'America/Lima',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    return fecha.toLocaleString('es-PE', opciones).replace(',', '');
}

// Notificaci√≥n visual elegante
function showNotification(msg, type="success") {
    notification.textContent = msg;
    notification.style.background = type === "error" ? "var(--error)" : "var(--secondary)";
    notification.style.color = "#19324a";
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3200);
}

// Registrar cashout - m√©todo GET
cashoutForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    document.getElementById('operatorSuccess').style.display = 'none';
    document.getElementById('operatorError').style.display = 'none';
    try {
        const operationCode = document.getElementById('operationCode').value;
        const operatorName = document.getElementById('operatorName').value;
        const company = document.getElementById('company').value;
        const url = `${SCRIPT_URL}?operationCode=${encodeURIComponent(operationCode)}&operatorName=${encodeURIComponent(operatorName)}&company=${encodeURIComponent(company)}`;
        await fetch(url);
        document.getElementById('operatorSuccess').style.display = '';
        showNotification("¬°Cash out enviado correctamente!", "success");
        cashoutForm.reset();
        cargarCola();
    } catch (err) {
        document.getElementById('operatorError').style.display = '';
        showNotification("Error al subir cash out.", "error");
    }
});

// Mostrar cola de verificaci√≥n
async function cargarCola() {
    verificationQueue.innerHTML = "<p>Cargando cash outs pendientes...</p>";
    try {
        const resp = await fetch(SCRIPT_URL);
        const items = await resp.json();
        verificationQueue.innerHTML = "";
        if (items.length === 0) {
            verificationQueue.innerHTML = '<p>No hay cash outs pendientes de verificaci√≥n.</p>';
            return;
        }
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cashout-item';
            div.innerHTML = `
                <div><strong>${item.operationCode}</strong> <span>${item.company}</span></div>
                <div>Operador: ${item.operatorName}</div>
                <div>Fecha: ${formatoPeru(item.timestamp)}</div>
                <input type="text" placeholder="Su nombre" class="supervisor-name" id="supervisor-${item.row}">
                <button onclick="verificarCashout(${item.row})">Verificar</button>
                <button onclick="rechazarCashout(${item.row})">Rechazar</button>
            `;
            verificationQueue.appendChild(div);
        });
    } catch (err) {
        verificationQueue.innerHTML = '<p>Error al cargar la cola.</p>';
    }
}
document.getElementById('forceRefresh').onclick = cargarCola;

window.verificarCashout = async function(row) {
    const supervisorName = document.getElementById('supervisor-' + row).value.trim();
    if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
    await fetch(`${SCRIPT_URL}?row=${row}&estado=verificado&supervisorName=${encodeURIComponent(supervisorName)}`);
    cargarCola();
    showNotification("¬°Cash out verificado!");
}
window.rechazarCashout = async function(row) {
    const supervisorName = document.getElementById('supervisor-' + row).value.trim();
    if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
    await fetch(`${SCRIPT_URL}?row=${row}&estado=rechazado&supervisorName=${encodeURIComponent(supervisorName)}`);
    cargarCola();
    showNotification("Cash out rechazado.");
}

// Si ya est√° autenticado como supervisor al cargar
if (sessionStorage.getItem('supervisorAuth') === 'true') {
    iniciarAutoRefreshCola();
    pollingSupervisor();
}

operatorBtn.click();
cargarCola();
    </script>
</body>
</html>