<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Cash Outs</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Nieve de fondo -->
    <div class="snow"></div>

    <!-- Bot√≥n de Cerrar Sesi√≥n Operador fuera del cuadro, arriba derecha -->
    <div class="logout-global">
        <button class="role-btn logout" id="operatorLogoutBtn">
            Cerrar Sesi√≥n Operador
        </button>
    </div>

    <div class="container">
        <header>
            <h1>üéÑ Sistema de Registro de Cash Outs üéÑ</h1>
            <p>Registro y verificaci√≥n de cash outs para m√∫ltiples compa√±√≠as</p>
        </header>

        <div class="role-selector">
            <button class="role-btn operator active" id="operatorBtn">Modo Operador</button>
            <button class="role-btn supervisor" id="supervisorBtn">üîí Modo Supervisor</button>
        </div>

        <!-- Secci√≥n operador -->
        <div id="operatorSection" class="form-section">
            <h2>Registrar nuevo cash out</h2>
            <form id="cashoutForm">
                <div class="form-group">
                    <label for="operationCode">C√≥digo de Operaci√≥n *</label>
                    <input type="text" id="operationCode" name="operationCode" required>
                </div>
                <div class="form-group">
                    <label for="operatorName">Nombre del Operador *</label>
                    <input type="text" id="operatorName" name="operatorName" required>
                </div>
                <div class="form-group">
                    <label for="company">Compa√±√≠a *</label>
                    <select id="company" name="company" required>
                        <option value="">Seleccione una compa√±√≠a</option>
                        <option value="Play Play Play">Play Play Play</option>
                        <option value="Lucky Lady">Lucky Lady</option>
                        <option value="Wise Gang">Wise Gang</option>
                        <option value="Ballerz World">Ballerz World</option>
                        <option value="Ocean Sluggerz">Ocean Sluggerz</option>
                        <option value="Elite">Elite</option>
                    </select>
                </div>
                <button type="submit">Enviar para verificaci√≥n</button>
            </form>

            <!-- Modal de Observaci√≥n -->
            <div id="observacionModal" class="modal-overlay" style="display:none;">
                <div class="modal-content">
                    <h3>¬øTienes alguna observaci√≥n sobre este cashout?</h3>
                    <div class="modal-buttons">
                        <button id="btnObservacionSi" class="btn-si">S√ç</button>
                        <button id="btnObservacionNo" class="btn-no">NO</button>
                    </div>
                    <div id="observacionInputContainer" style="display:none; margin-top: 15px;">
                        <textarea id="observacionTexto" placeholder="Escribe tu observaci√≥n aqu√≠..." rows="3"></textarea>
                        <button id="btnEnviarConObservacion">Enviar Cashout</button>
                    </div>
                </div>
            </div>

            <div id="operatorSuccess" class="success-message">
                ¬°Cash out registrado correctamente! Esperando verificaci√≥n del supervisor.
            </div>
            <div id="operatorError" class="error-message">
                Ha ocurrido un error al registrar el cash out. Por favor, int√©ntalo de nuevo.
            </div>
        </div>

        <!-- Secci√≥n supervisor -->
        <div id="supervisorSection" class="form-section" style="display: none;">
            <h2>Cola de Verificaci√≥n</h2>
            <p>Cash outs pendientes de segunda verificaci√≥n:</p>
            <div id="verificationQueue" class="queue">
                <p>Cargando cash outs pendientes...</p>
            </div>
            <div id="supervisorSuccess" class="success-message">¬°Cash out verificado!</div>
            <div id="supervisorError" class="error-message">Error al procesar el cash out.</div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="forceRefresh" style="width: auto; display: inline-block; padding: 10px 22px;">
                    üîÑ Actualizar Cola
                </button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
    // URL central del Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzL2wlxsKRI3mDffTl-IPm0aqE_qjygcyaPnT3J8zfrC1TDzcj1BNpBI_wXsQu1PsrmXQ/exec";

    const operatorBtn = document.getElementById('operatorBtn');
    const supervisorBtn = document.getElementById('supervisorBtn');
    const operatorSection = document.getElementById('operatorSection');
    const supervisorSection = document.getElementById('supervisorSection');
    const cashoutForm = document.getElementById('cashoutForm');
    const verificationQueue = document.getElementById('verificationQueue');
    const notification = document.getElementById('notification');
    const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');

    const OPERATOR_NAME_KEY = 'operatorNameTurno';

    // ---- Nombre de operador (sessionStorage + readonly) ----
    function actualizarUIConNombreOperador(nombre) {
        const operatorNameInput = document.getElementById('operatorName');
        if (operatorNameInput) {
            operatorNameInput.value = nombre || '';
            operatorNameInput.readOnly = !!(nombre && nombre.trim() !== '');
        }
    }

    function pedirNombreOperadorSiHaceFalta() {
        let nombre = sessionStorage.getItem(OPERATOR_NAME_KEY);
        if (!nombre) {
            nombre = prompt('¬øCu√°l es tu nombre de Operador? Este ser√° tu nombre durante el resto del turno:');
            if (nombre) nombre = nombre.trim();
            if (!nombre) return pedirNombreOperadorSiHaceFalta();
            sessionStorage.setItem(OPERATOR_NAME_KEY, nombre);
        }
        actualizarUIConNombreOperador(nombre);
    }

    // Cerrar sesi√≥n de operador (cambiar de persona)
    operatorLogoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem(OPERATOR_NAME_KEY);
        actualizarUIConNombreOperador('');
        pedirNombreOperadorSiHaceFalta();
        showNotification('Sesi√≥n de operador cerrada. Nuevo operador autenticado.', 'success');
    });

    // Auto-refresh de cola en modo supervisor
    let colaAutoRefresh = null;
    function iniciarAutoRefreshCola() {
        if (colaAutoRefresh) return;
        colaAutoRefresh = setInterval(() => {
            if (supervisorSection.style.display === 'block') {
                cargarCola();
            }
        }, 50000); // cada 50 segundos
    }
    function detenerAutoRefreshCola() {
        if (colaAutoRefresh) {
            clearInterval(colaAutoRefresh);
            colaAutoRefresh = null;
        }
    }

    // Cambio de modo Operador/Supervisor
    operatorBtn.addEventListener('click', () => {
        operatorBtn.classList.add('active');
        supervisorBtn.classList.remove('active');
        operatorSection.style.display = 'block';
        supervisorSection.style.display = 'none';
        detenerAutoRefreshCola();
    });

    supervisorBtn.addEventListener('click', () => {
        const isAuthenticated = sessionStorage.getItem('supervisorAuth') === 'true';
        if (!isAuthenticated) {
            const password = prompt('Ingrese la contrase√±a de supervisor:');
            if (password === 'superctrl2023') {
                sessionStorage.setItem('supervisorAuth', 'true');
                showNotification('‚úÖ Acceso autorizado a modo supervisor', 'success');
            } else {
                showNotification('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }
        }
        supervisorBtn.classList.add('active');
        operatorBtn.classList.remove('active');
        supervisorSection.style.display = 'block';
        operatorSection.style.display = 'none';
        cargarCola();
        iniciarAutoRefreshCola();
    });

    // Formato Per√∫ para fechas
    function formatoPeru(fechaIso) {
        const fecha = new Date(fechaIso);
        const opciones = {
            timeZone: 'America/Lima',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        return fecha.toLocaleString('es-PE', opciones).replace(',', '');
    }

    // Notificaci√≥n visual (versi√≥n navide√±a)
    function showNotification(msg, type="success") {
        notification.textContent = msg;

        if (type === "error") {
            notification.style.background = "linear-gradient(135deg, #BB2528, #ff6b6b)";
            notification.style.color = "#fff5f5";
        } else {
            notification.style.background = "linear-gradient(135deg, #165B33, #74d680)";
            notification.style.color = "#f0fff4";
        }

        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3200);
    }

    // Variables para guardar datos del cashout temporalmente
    let cashoutPendiente = null;

    // Registrar cashout - ahora con modal de observaci√≥n
    cashoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('operatorSuccess').style.display = 'none';
        document.getElementById('operatorError').style.display = 'none';

        // Guardar datos del cashout temporalmente
        cashoutPendiente = {
            operationCode: document.getElementById('operationCode').value,
            operatorName: document.getElementById('operatorName').value,
            company: document.getElementById('company').value,
            observacion: ""
        };

        // Mostrar modal de observaci√≥n
        document.getElementById('observacionModal').style.display = 'flex';
        document.getElementById('observacionInputContainer').style.display = 'none';
        document.getElementById('observacionTexto').value = '';
    });

    // Bot√≥n S√ç - mostrar campo de observaci√≥n
    document.getElementById('btnObservacionSi').addEventListener('click', () => {
        document.getElementById('observacionInputContainer').style.display = 'block';
    });

    // Bot√≥n NO - enviar sin observaci√≥n
    document.getElementById('btnObservacionNo').addEventListener('click', async () => {
        cashoutPendiente.observacion = "";
        await enviarCashout();
    });

    // Bot√≥n Enviar con Observaci√≥n
    document.getElementById('btnEnviarConObservacion').addEventListener('click', async () => {
        const obs = document.getElementById('observacionTexto').value.trim();
        if (!obs) {
            showNotification("Por favor, escribe una observaci√≥n o selecciona NO.", "error");
            return;
        }
        cashoutPendiente.observacion = obs;
        await enviarCashout();
    });

    // Funci√≥n para enviar el cashout al servidor
    async function enviarCashout() {
        try {
            const { operationCode, operatorName, company, observacion } = cashoutPendiente;
            const url = `${SCRIPT_URL}?operationCode=${encodeURIComponent(operationCode)}&operatorName=${encodeURIComponent(operatorName)}&company=${encodeURIComponent(company)}&observacion=${encodeURIComponent(observacion)}`;
            await fetch(url);

            document.getElementById('observacionModal').style.display = 'none';
            document.getElementById('operatorSuccess').style.display = '';
            showNotification("¬°Cash out enviado correctamente!", "success");
            cashoutForm.reset();
            const nombreActual = sessionStorage.getItem(OPERATOR_NAME_KEY) || '';
            actualizarUIConNombreOperador(nombreActual);
            cargarCola();
        } catch (err) {
            document.getElementById('observacionModal').style.display = 'none';
            document.getElementById('operatorError').style.display = '';
            showNotification("Error al subir cash out.", "error");
        }
        cashoutPendiente = null;
    }

    // Mostrar cola de verificaci√≥n (ordenada por timestamp, m√°s recientes primero)
    async function cargarCola() {
        verificationQueue.innerHTML = "<p>Cargando cash outs pendientes...</p>";
        try {
            const resp = await fetch(SCRIPT_URL);
            let items = await resp.json();

            // Ordenar por timestamp descendente (m√°s reciente primero)
            items.sort((a, b) => {
                const fechaA = new Date(a.timestamp);
                const fechaB = new Date(b.timestamp);
                return fechaB - fechaA;
            });

            const fragment = document.createDocumentFragment();

            if (items.length === 0) {
                const p = document.createElement('p');
                p.textContent = "No hay cash outs pendientes de verificaci√≥n.";
                fragment.appendChild(p);
            } else {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'cashout-item';
                    
                    // Mostrar observaci√≥n si existe
                    const obsHtml = item.observacion ? `<div class="observacion-tag">üìù Observaci√≥n: ${item.observacion}</div>` : '';
                    
                    div.innerHTML = `
                      <div><strong>${item.operationCode}</strong> <span>${item.company}</span></div>
                      <div>Operador: ${item.operatorName}</div>
                      <div>Fecha: ${formatoPeru(item.timestamp)}</div>
                      ${obsHtml}
                      <select class="supervisor-name" id="supervisor-${item.row}">
                          <option value="">Seleccione supervisor</option>
                          <option value="Micaela Albareda">Micaela Albareda</option>
                          <option value="Micaela Zevallos">Micaela Zevallos</option>
                          <option value="Abel Juscamaita">Abel Juscamaita</option>
                          <option value="Nicole Tello">Nicole Tello</option>
                          <option value="Amelia Ureta">Amelia Ureta</option>
                          <option value="Otro">Otro...</option>
                      </select>
                      <input type="text" class="supervisor-name-manual"
                             id="supervisor-manual-${item.row}"
                             placeholder="Nombre manual (si eligi√≥ 'Otro')"
                             style="display:none;margin-top:8px;"/>
                      <button onclick="verificarCashout(${item.row})">Verificar</button>
                      <button onclick="rechazarCashout(${item.row})">Rechazar</button>
                    `;
                    div.querySelector(`#supervisor-${item.row}`).addEventListener('change', function() {
                        const manualInput = div.querySelector(`#supervisor-manual-${item.row}`);
                        if (this.value === "Otro") {
                            manualInput.style.display = '';
                        } else {
                            manualInput.style.display = 'none';
                            manualInput.value = '';
                        }
                    });
                    fragment.appendChild(div);
                });
            }
            verificationQueue.innerHTML = "";
            verificationQueue.appendChild(fragment);
        } catch (err) {
            verificationQueue.innerHTML = '<p>Error al cargar la cola.</p>';
        }
    }

    document.getElementById('forceRefresh').onclick = cargarCola;

    window.verificarCashout = async function(row) {
      const supervisorSelect = document.getElementById('supervisor-' + row);
      const supervisorManual = document.getElementById('supervisor-manual-' + row);
      let supervisorName = supervisorSelect.value;
      if (supervisorName === "Otro") supervisorName = supervisorManual.value.trim();
      if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
      await fetch(`${SCRIPT_URL}?row=${row}&estado=verificado&supervisorName=${encodeURIComponent(supervisorName)}`);
      cargarCola();
      showNotification("¬°Cash out verificado!");
    };

    window.rechazarCashout = async function(row) {
      const supervisorSelect = document.getElementById('supervisor-' + row);
      const supervisorManual = document.getElementById('supervisor-manual-' + row);
      let supervisorName = supervisorSelect.value;
      if (supervisorName === "Otro") supervisorName = supervisorManual.value.trim();
      if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
      await fetch(`${SCRIPT_URL}?row=${row}&estado=rechazado&supervisorName=${encodeURIComponent(supervisorName)}`);
      cargarCola();
      showNotification("Cash out rechazado.");
    };

    // Al cargar
    if (sessionStorage.getItem('supervisorAuth') === 'true') {
        iniciarAutoRefreshCola();
    }

    pedirNombreOperadorSiHaceFalta();
    operatorBtn.click();
    cargarCola();
    </script>
</body>
</html>