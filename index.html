<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Cash Outs</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <!-- BotÃ³n de Cerrar SesiÃ³n Operador fuera del cuadro, arriba derecha -->
    <div class="logout-global">
        <button class="role-btn logout" id="operatorLogoutBtn">
            Cerrar SesiÃ³n Operador
        </button>
    </div>

    <div class="container">
        <header>
            <h1>Sistema de Registro de Cash Outs</h1>
            <p>Registro y verificaciÃ³n de cash outs para mÃºltiples compaÃ±Ã­as</p>
        </header>

        <div class="role-selector">
            <button class="role-btn operator active" id="operatorBtn">Modo Operador</button>
            <button class="role-btn supervisor" id="supervisorBtn">ðŸ”’ Modo Supervisor</button>
        </div>

        <!-- SecciÃ³n operador -->
        <div id="operatorSection" class="form-section">
            <h2>Registrar nuevo cash out</h2>
            <form id="cashoutForm">
                <div class="form-group">
                    <label for="operationCode">CÃ³digo de OperaciÃ³n *</label>
                    <input type="text" id="operationCode" name="operationCode" required>
                </div>
                <div class="form-group">
                    <label for="operatorName">Nombre del Operador *</label>
                    <input type="text" id="operatorName" name="operatorName" required>
                </div>
                <div class="form-group">
                    <label for="company">CompaÃ±Ã­a *</label>
                    <select id="company" name="company" required>
                        <option value="">Seleccione una compaÃ±Ã­a</option>
                        <option value="Play Play Play">Play Play Play</option>
                        <option value="Lucky Lady">Lucky Lady</option>
                        <option value="Wise Gang">Wise Gang</option>
                        <option value="Ballerz World">Ballerz World</option>
                        <option value="Ocean Sluggerz">Ocean Sluggerz</option>
                        <option value="Elite">Elite</option>
                    </select>
                </div>
                <button type="submit">Enviar para verificaciÃ³n</button>
            </form>
            <div id="operatorSuccess" class="success-message">
                Â¡Cash out registrado correctamente! Esperando verificaciÃ³n del supervisor.
            </div>
            <div id="operatorError" class="error-message">
                Ha ocurrido un error al registrar el cash out. Por favor, intÃ©ntalo de nuevo.
            </div>
        </div>

        <!-- SecciÃ³n supervisor -->
        <div id="supervisorSection" class="form-section" style="display: none;">
            <h2>Cola de VerificaciÃ³n</h2>
            <p>Cash outs pendientes de segunda verificaciÃ³n:</p>
            <div id="verificationQueue" class="queue">
                <p>Cargando cash outs pendientes...</p>
            </div>
            <div id="supervisorSuccess" class="success-message">Â¡Cash out verificado!</div>
            <div id="supervisorError" class="error-message">Error al procesar el cash out.</div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="forceRefresh" style="width: auto; display: inline-block; padding: 10px 22px;">
                    ðŸ”„ Actualizar Cola
                </button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
    // URL central del Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzL2wlxsKRI3mDffTl-IPm0aqE_qjygcyaPnT3J8zfrC1TDzcj1BNpBI_wXsQu1PsrmXQ/exec";

    const operatorBtn = document.getElementById('operatorBtn');
    const supervisorBtn = document.getElementById('supervisorBtn');
    const operatorSection = document.getElementById('operatorSection');
    const supervisorSection = document.getElementById('supervisorSection');
    const cashoutForm = document.getElementById('cashoutForm');
    const verificationQueue = document.getElementById('verificationQueue');
    const notification = document.getElementById('notification');
    const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');

    const OPERATOR_NAME_KEY = 'operatorNameTurno';

    // ---- Nombre de operador (sessionStorage + readonly) ----
    function actualizarUIConNombreOperador(nombre) {
        const operatorNameInput = document.getElementById('operatorName');
        if (operatorNameInput) {
            operatorNameInput.value = nombre || '';
            operatorNameInput.readOnly = !!(nombre && nombre.trim() !== '');
        }
    }

    function pedirNombreOperadorSiHaceFalta() {
        let nombre = sessionStorage.getItem(OPERATOR_NAME_KEY);
        if (!nombre) {
            nombre = prompt('Â¿CuÃ¡l es tu nombre de Operador? Este serÃ¡ tu nombre durante el resto del turno:');
            if (nombre) nombre = nombre.trim();
            if (!nombre) return pedirNombreOperadorSiHaceFalta();
            sessionStorage.setItem(OPERATOR_NAME_KEY, nombre);
        }
        actualizarUIConNombreOperador(nombre);
    }

    // Cerrar sesiÃ³n de operador (cambiar de persona)
    operatorLogoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem(OPERATOR_NAME_KEY);
        actualizarUIConNombreOperador('');
        pedirNombreOperadorSiHaceFalta();
        showNotification('SesiÃ³n de operador cerrada. Nuevo operador autenticado.', 'success');
    });

    // Auto-refresh de cola en modo supervisor
    let colaAutoRefresh = null;
    function iniciarAutoRefreshCola() {
        if (colaAutoRefresh) return;
        colaAutoRefresh = setInterval(() => {
            if (supervisorSection.style.display === 'block') {
                cargarCola();
            }
        }, 50000); // cada 50 segundos
    }
    function detenerAutoRefreshCola() {
        if (colaAutoRefresh) {
            clearInterval(colaAutoRefresh);
            colaAutoRefresh = null;
        }
    }

    // Cambio de modo Operador/Supervisor
    operatorBtn.addEventListener('click', () => {
        operatorBtn.classList.add('active');
        supervisorBtn.classList.remove('active');
        operatorSection.style.display = 'block';
        supervisorSection.style.display = 'none';
        detenerAutoRefreshCola();
    });

    supervisorBtn.addEventListener('click', () => {
        const isAuthenticated = sessionStorage.getItem('supervisorAuth') === 'true';
        if (!isAuthenticated) {
            const password = prompt('Ingrese la contraseÃ±a de supervisor:');
            if (password === 'superctrl2023') {
                sessionStorage.setItem('supervisorAuth', 'true');
                showNotification('âœ… Acceso autorizado a modo supervisor', 'success');
            } else {
                showNotification('âŒ ContraseÃ±a incorrecta', 'error');
                return;
            }
        }
        supervisorBtn.classList.add('active');
        operatorBtn.classList.remove('active');
        supervisorSection.style.display = 'block';
        operatorSection.style.display = 'none';
        cargarCola();
        iniciarAutoRefreshCola();
    });

    // Formato PerÃº para fechas
    function formatoPeru(fechaIso) {
        const fecha = new Date(fechaIso);
        const opciones = {
            timeZone: 'America/Lima',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        return fecha.toLocaleString('es-PE', opciones).replace(',', '');
    }

    // NotificaciÃ³n visual en pantalla (MANTIENE INTACTO)
    function showNotification(msg, type="success") {
        notification.textContent = msg;
        notification.style.background = type === "error" ? "var(--error)" : "var(--secondary)";
        notification.style.color = "#19324a";
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3200);
    }

    // Registrar cashout
    cashoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('operatorSuccess').style.display = 'none';
        document.getElementById('operatorError').style.display = 'none';
        try {
            const operationCode = document.getElementById('operationCode').value;
            const operatorName = document.getElementById('operatorName').value;
            const company = document.getElementById('company').value;
            const url = `${SCRIPT_URL}?operationCode=${encodeURIComponent(operationCode)}&operatorName=${encodeURIComponent(operatorName)}&company=${encodeURIComponent(company)}`;
            await fetch(url);
            document.getElementById('operatorSuccess').style.display = '';
            showNotification("Â¡Cash out enviado correctamente!", "success");
            cashoutForm.reset();
            const nombreActual = sessionStorage.getItem(OPERATOR_NAME_KEY) || '';
            actualizarUIConNombreOperador(nombreActual);
            cargarCola();
        } catch (err) {
            document.getElementById('operatorError').style.display = '';
            showNotification("Error al subir cash out.", "error");
        }
    });

    // Mostrar cola de verificaciÃ³n (ordenada por timestamp, mÃ¡s recientes primero)
    async function cargarCola() {
        verificationQueue.innerHTML = "<p>Cargando cash outs pendientes...</p>";
        try {
            const resp = await fetch(SCRIPT_URL);
            let items = await resp.json();

            // Ordenar por timestamp descendente (mÃ¡s reciente primero)
            items.sort((a, b) => {
                const fechaA = new Date(a.timestamp);
                const fechaB = new Date(b.timestamp);
                return fechaB - fechaA;
            });

            const fragment = document.createDocumentFragment();

            if (items.length === 0) {
                const p = document.createElement('p');
                p.textContent = "No hay cash outs pendientes de verificaciÃ³n.";
                fragment.appendChild(p);
            } else {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'cashout-item';
                    div.innerHTML = `
                      <div><strong>${item.operationCode}</strong> <span>${item.company}</span></div>
                      <div>Operador: ${item.operatorName}</div>
                      <div>Fecha: ${formatoPeru(item.timestamp)}</div>
                      <select class="supervisor-name" id="supervisor-${item.row}">
                          <option value="">Seleccione supervisor</option>
                          <option value="Micaela Albareda">Micaela Albareda</option>
                          <option value="Micaela Zevallos">Micaela Zevallos</option>
                          <option value="Abel Juscamaita">Abel Juscamaita</option>
                          <option value="Nicole Tello">Nicole Tello</option>
                          <option value="Brandy Hora">Brandy Hora</option>
                          <option value="Otro">Otro...</option>
                      </select>
                      <input type="text" class="supervisor-name-manual"
                             id="supervisor-manual-${item.row}"
                             placeholder="Nombre manual (si eligiÃ³ 'Otro')"
                             style="display:none;margin-top:8px;"/>
                      <button onclick="verificarCashout(${item.row})">Verificar</button>
                      <button onclick="rechazarCashout(${item.row})">Rechazar</button>
                    `;
                    div.querySelector(`#supervisor-${item.row}`).addEventListener('change', function() {
                        const manualInput = div.querySelector(`#supervisor-manual-${item.row}`);
                        if (this.value === "Otro") {
                            manualInput.style.display = '';
                        } else {
                            manualInput.style.display = 'none';
                            manualInput.value = '';
                        }
                    });
                    fragment.appendChild(div);
                });
            }
            verificationQueue.innerHTML = "";
            verificationQueue.appendChild(fragment);
        } catch (err) {
            verificationQueue.innerHTML = '<p>Error al cargar la cola.</p>';
        }
    }

    document.getElementById('forceRefresh').onclick = cargarCola;

    window.verificarCashout = async function(row) {
      const supervisorSelect = document.getElementById('supervisor-' + row);
      const supervisorManual = document.getElementById('supervisor-manual-' + row);
      let supervisorName = supervisorSelect.value;
      if (supervisorName === "Otro") supervisorName = supervisorManual.value.trim();
      if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
      await fetch(`${SCRIPT_URL}?row=${row}&estado=verificado&supervisorName=${encodeURIComponent(supervisorName)}`);
      cargarCola();
      showNotification("Â¡Cash out verificado!");
    };

    window.rechazarCashout = async function(row) {
      const supervisorSelect = document.getElementById('supervisor-' + row);
      const supervisorManual = document.getElementById('supervisor-manual-' + row);
      let supervisorName = supervisorSelect.value;
      if (supervisorName === "Otro") supervisorName = supervisorManual.value.trim();
      if (!supervisorName) { showNotification("Falta nombre de supervisor.", "error"); return; }
      await fetch(`${SCRIPT_URL}?row=${row}&estado=rechazado&supervisorName=${encodeURIComponent(supervisorName)}`);
      cargarCola();
      showNotification("Cash out rechazado.");
    };

    // Al cargar
    if (sessionStorage.getItem('supervisorAuth') === 'true') {
        iniciarAutoRefreshCola();
    }

    pedirNombreOperadorSiHaceFalta();
    operatorBtn.click();
    cargarCola();
    </script>
</body>
</html>